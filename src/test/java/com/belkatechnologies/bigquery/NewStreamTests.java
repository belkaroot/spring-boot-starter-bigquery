package com.belkatechnologies.bigquery;

import com.belkatechnologies.bigquery.configuration.BigQueryAutoConfiguration;
import com.belkatechnologies.bigquery.configuration.BigQueryProperties;
import com.belkatechnologies.bigquery.configuration.StreamingAutoConfiguration;
import com.belkatechnologies.bigquery.manager.BigQueryManager;
import com.belkatechnologies.bigquery.manager.FieldValueListDecorator;
import com.belkatechnologies.bigquery.streaming.StreamingManager;
import com.google.cloud.bigquery.*;
import com.google.cloud.bigquery.storage.v1.TableName;
import lombok.SneakyThrows;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.time.Instant;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

@SpringBootTest(classes = {StreamingAutoConfiguration.class, BigQueryAutoConfiguration.class, TestCallBack.class})
@Slf4j
public class NewStreamTests {

    private static final List<String> REQ_CONST = List.of(
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=489779456#is#bgs_s_id=614#is#bgs_a_id=35559#is#timestamp_client=1697758859#is#global_energy=43#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=exploration_action#is#object_id=500018#is#object_guid=b3cc85e04e4577946a4bb308e07d3653#is#object_name=P_007TF_Well_02_02#is#object_x=9#is#object_y=3#is#energy=15#is#experience=0#is#payload=85381ef4-be22-4568-92b7-36258f9a5bda:0139477250#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=489779456#is#bgs_s_id=614#is#bgs_a_id=35560#is#timestamp_client=1697758859#is#global_energy=43#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_energy_spend#is#payload=85381ef4-be22-4568-92b7-36258f9a5bda:0139477250#is#item=680bcb6c1f4d9471689c49d611c8664f#is#item_name=M_000ML_Energy#is#amount=15#is#source=exploration#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=489779456#is#bgs_s_id=614#is#bgs_a_id=35561#is#timestamp_client=1697758859#is#global_energy=28#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=offer_display#is#offer_id=EnergyOffer_27#is#offer_type=EnergyOffer#is#segment=PaymentCNT_Total_[0;0]#is#status=Initial#is#source=EnergySpendTrigger",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=489779456#is#bgs_s_id=614#is#bgs_a_id=35562#is#timestamp_client=1697758863#is#global_energy=28#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_energy_hoard#is#payload=66b6f8b7-0165-4425-8758-a90e3b4db4fd:2063312414#is#item=680bcb6c1f4d9471689c49d611c8664f#is#item_name=M_000ML_Energy#is#amount=1#is#source=recharge",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=489779456#is#bgs_s_id=614#is#bgs_a_id=35563#is#timestamp_client=1697758869#is#global_energy=29#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=exploration_action#is#object_id=500031#is#object_guid=2b1bcb4d530fc1046a613ed422e82401#is#object_name=P_007TF_Well_03_02#is#object_x=24#is#object_y=19#is#energy=15#is#experience=0#is#payload=358d80e4-97ae-412a-b620-321aeb9a802b:0277827087#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=489779456#is#bgs_s_id=614#is#bgs_a_id=35564#is#timestamp_client=1697758869#is#global_energy=29#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_energy_spend#is#payload=358d80e4-97ae-412a-b620-321aeb9a802b:0277827087#is#item=680bcb6c1f4d9471689c49d611c8664f#is#item_name=M_000ML_Energy#is#amount=15#is#source=exploration",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=489779456#is#bgs_s_id=614#is#bgs_a_id=35565#is#timestamp_client=1697758878#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=session_alive#is#session_from=1697758828#is#session_till=0#is#duration=242#is#status=open",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=489779456#is#bgs_s_id=614#is#bgs_a_id=35566#is#timestamp_client=1697758883#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=session_close#is#session_from=1697758828#is#session_till=1697758883#is#duration=247#is#status=closed#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=489779456#is#bgs_s_id=614#is#bgs_a_id=35567#is#timestamp_client=1697758883#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=location_pause#is#location=P_007TF#is#type=PERMANENT_EXPEDITION#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35568#is#timestamp_client=1697758948#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=session_start#is#session_from=1697758948#is#session_till=0#is#duration=247#is#status=open#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35569#is#timestamp_client=1697758948#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=location_resume#is#location=P_007TF#is#type=PERMANENT_EXPEDITION#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35570#is#timestamp_client=1697758948#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_item_hoard#is#payload=2dca3115-4e79-4850-97c4-c5f9740e3df6:0998326504#is#item=1eb33be619ab3314583fe4edbb576808#is#item_name=P_007TF_Line3_Item1#is#amount=3#is#source=exploration#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35571#is#timestamp_client=1697758948#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=exploration_reward#is#object_id=500018#is#object_guid=b3cc85e04e4577946a4bb308e07d3653#is#object_name=P_007TF_Well_02_02#is#object_x=9#is#object_y=3#is#energy=0#is#experience=0#is#payload=2dca3115-4e79-4850-97c4-c5f9740e3df6:0998326504#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35572#is#timestamp_client=1697758948#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_item_hoard#is#payload=a94273e5-ffbc-4522-adfc-ab62c13d8916:1424918023#is#item=1eb33be619ab3314583fe4edbb576808#is#item_name=P_007TF_Line3_Item1#is#amount=3#is#source=exploration#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35573#is#timestamp_client=1697758948#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=exploration_reward#is#object_id=500031#is#object_guid=2b1bcb4d530fc1046a613ed422e82401#is#object_name=P_007TF_Well_03_02#is#object_x=24#is#object_y=19#is#energy=0#is#experience=0#is#payload=a94273e5-ffbc-4522-adfc-ab62c13d8916:1424918023",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35574#is#timestamp_client=1697758964#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_item_spend#is#payload=dd5de480-0c69-42eb-ae55-afbe6c679e12:0140247414#is#item=1eb33be619ab3314583fe4edbb576808#is#item_name=P_007TF_Line3_Item1#is#amount=6#is#source=merge#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35575#is#timestamp_client=1697758964#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_item_hoard#is#payload=dd5de480-0c69-42eb-ae55-afbe6c679e12:0140247414#is#item=44e50dcbf1f82f94a890bdc2aef9257d#is#item_name=P_007TF_Line3_Item2#is#amount=2#is#source=merge#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35576#is#timestamp_client=1697758964#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_experience_hoard#is#payload=dd5de480-0c69-42eb-ae55-afbe6c679e12:0140247414#is#item=bb21e7d2e8d0749149b3007d549905a9#is#item_name=M_000ML_Experience#is#amount=2#is#source=merge",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35577#is#timestamp_client=1697758970#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_item_spend#is#payload=7566b1a1-7517-4607-b25e-8b398ad3f9c2:0604920917#is#item=44e50dcbf1f82f94a890bdc2aef9257d#is#item_name=P_007TF_Line3_Item2#is#amount=3#is#source=merge#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35578#is#timestamp_client=1697758970#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_item_hoard#is#payload=7566b1a1-7517-4607-b25e-8b398ad3f9c2:0604920917#is#item=32695f6c6ed1c8f44828a16fc4190131#is#item_name=P_007TF_Line3_Item3#is#amount=1#is#source=merge#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35579#is#timestamp_client=1697758970#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_experience_hoard#is#payload=7566b1a1-7517-4607-b25e-8b398ad3f9c2:0604920917#is#item=bb21e7d2e8d0749149b3007d549905a9#is#item_name=M_000ML_Experience#is#amount=2#is#source=merge",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35580#is#timestamp_client=1697759003#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=session_alive#is#session_from=1697758948#is#session_till=0#is#duration=302#is#status=open",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35581#is#timestamp_client=1697759043#is#global_energy=14#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_energy_hoard#is#payload=5677ab7d-f60c-4b77-9d26-cf9ea42acdd1:0602480718#is#item=680bcb6c1f4d9471689c49d611c8664f#is#item_name=M_000ML_Energy#is#amount=1#is#source=recharge",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35582#is#timestamp_client=1697759045#is#global_energy=15#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=exploration_action#is#object_id=772#is#object_guid=c595696fe53d9ad498ce74d19ac5028e#is#object_name=P_007TF_Cactus_02#is#object_x=50#is#object_y=33#is#energy=15#is#experience=0#is#payload=c85e61e7-7baf-4fdb-82e0-ac7bfe0b71bc:0490815480#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35583#is#timestamp_client=1697759045#is#global_energy=15#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_energy_spend#is#payload=c85e61e7-7baf-4fdb-82e0-ac7bfe0b71bc:0490815480#is#item=680bcb6c1f4d9471689c49d611c8664f#is#item_name=M_000ML_Energy#is#amount=15#is#source=exploration#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35584#is#timestamp_client=1697759045#is#global_energy=0#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_item_hoard#is#payload=8e18ff7c-8536-45ce-8585-8ab53eeb4d6e:0465255032#is#item=204b6e18e9a4adf4990210662937d5df#is#item_name=P_007TF_Line5_Item1#is#amount=7#is#source=exploration#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35585#is#timestamp_client=1697759045#is#global_energy=0#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_experience_hoard#is#payload=8e18ff7c-8536-45ce-8585-8ab53eeb4d6e:0465255032#is#item=bb21e7d2e8d0749149b3007d549905a9#is#item_name=M_000ML_Experience#is#amount=1#is#source=exploration#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35586#is#timestamp_client=1697759045#is#global_energy=0#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=exploration_reward#is#object_id=772#is#object_guid=c595696fe53d9ad498ce74d19ac5028e#is#object_name=P_007TF_Cactus_02#is#object_x=50#is#object_y=33#is#energy=0#is#experience=1#is#payload=8e18ff7c-8536-45ce-8585-8ab53eeb4d6e:0465255032",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35587#is#timestamp_client=1697759048#is#global_energy=0#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=exploration_action#is#object_id=863#is#object_guid=af069838e582d42229d1d9de6cf1bb20#is#object_name=S_EnergySmall#is#object_x=50#is#object_y=35#is#energy=0#is#experience=0#is#payload=#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35588#is#timestamp_client=1697759048#is#global_energy=0#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_energy_hoard#is#payload=fe25583a-0cb2-48bc-8474-eec6a31f75e3:0747747322#is#item=680bcb6c1f4d9471689c49d611c8664f#is#item_name=M_000ML_Energy#is#amount=10#is#source=exploration#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35589#is#timestamp_client=1697759048#is#global_energy=10#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=exploration_reward#is#object_id=863#is#object_guid=af069838e582d42229d1d9de6cf1bb20#is#object_name=S_EnergySmall#is#object_x=50#is#object_y=35#is#energy=0#is#experience=0#is#payload=fe25583a-0cb2-48bc-8474-eec6a31f75e3:0747747322",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35590#is#timestamp_client=1697759063#is#global_energy=10#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=session_alive#is#session_from=1697758948#is#session_till=0#is#duration=362#is#status=open",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35591#is#timestamp_client=1697759077#is#global_energy=10#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_item_spend#is#payload=77e7a30a-6076-40a2-bd06-643d66639144:0588103502#is#item=204b6e18e9a4adf4990210662937d5df#is#item_name=P_007TF_Line5_Item1#is#amount=13#is#source=merge#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35592#is#timestamp_client=1697759077#is#global_energy=10#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_item_hoard#is#payload=77e7a30a-6076-40a2-bd06-643d66639144:0588103502#is#item=c197c716fe755e6458b76c048f9c4618#is#item_name=P_007TF_Line5_Item2#is#amount=5#is#source=merge#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35593#is#timestamp_client=1697759077#is#global_energy=10#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_experience_hoard#is#payload=77e7a30a-6076-40a2-bd06-643d66639144:0588103502#is#item=bb21e7d2e8d0749149b3007d549905a9#is#item_name=M_000ML_Experience#is#amount=5#is#source=merge",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35594#is#timestamp_client=1697759079#is#global_energy=10#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_item_spend#is#payload=15f6f385-6691-4c3a-b08c-1aa0ac625a1b:1171826315#is#item=c197c716fe755e6458b76c048f9c4618#is#item_name=P_007TF_Line5_Item2#is#amount=9#is#source=merge#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35595#is#timestamp_client=1697759079#is#global_energy=10#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_item_hoard#is#payload=15f6f385-6691-4c3a-b08c-1aa0ac625a1b:1171826315#is#item=ee23dc862cf3a334da9aed5888275b6f#is#item_name=P_007TF_Line5_Item3#is#amount=3#is#source=merge#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35596#is#timestamp_client=1697759079#is#global_energy=10#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_experience_hoard#is#payload=15f6f385-6691-4c3a-b08c-1aa0ac625a1b:1171826315#is#item=bb21e7d2e8d0749149b3007d549905a9#is#item_name=M_000ML_Experience#is#amount=6#is#source=merge",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35597#is#timestamp_client=1697759087#is#global_energy=10#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=session_close#is#session_from=1697758948#is#session_till=1697759087#is#duration=386#is#status=closed#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=333645824#is#bgs_s_id=615#is#bgs_a_id=35598#is#timestamp_client=1697759087#is#global_energy=10#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=228#is#session_version=0.2.2#is#eventType=logEvent#is#event=location_pause#is#location=P_007TF#is#type=PERMANENT_EXPEDITION#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=1650588160#is#bgs_s_id=616#is#bgs_a_id=35599#is#timestamp_client=1697759421#is#global_energy=10#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=229#is#session_version=0.2.2#is#eventType=logEvent#is#event=session_start#is#session_from=1697759421#is#session_till=0#is#duration=0#is#status=open#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=1650588160#is#bgs_s_id=616#is#bgs_a_id=35600#is#timestamp_client=1697759421#is#global_energy=10#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=229#is#session_version=0.2.2#is#eventType=logEvent#is#event=location_resume#is#location=P_007TF#is#type=PERMANENT_EXPEDITION#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=1650588160#is#bgs_s_id=616#is#bgs_a_id=35601#is#timestamp_client=1697759421#is#global_energy=10#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=229#is#session_version=0.2.2#is#eventType=logEvent#is#event=consumable_energy_hoard#is#payload=6bec6b5d-9003-44bc-bee9-5796e72a76fb:1107936036#is#item=680bcb6c1f4d9471689c49d611c8664f#is#item_name=M_000ML_Energy#is#amount=2#is#source=recharge",
            "session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=1650588160#is#bgs_s_id=616#is#bgs_a_id=35602#is#timestamp_client=1697759427#is#global_energy=12#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=229#is#session_version=0.2.2#is#eventType=logEvent#is#event=location_exit#is#location=P_007TF#is#type=PERMANENT_EXPEDITION#os#session_platform=iOS#is#profile_seed=-1775303962373486594#is#bgs_g_seed=1028339584#is#bgs_s_seed=1650588160#is#bgs_s_id=616#is#bgs_a_id=35603#is#timestamp_client=1697759427#is#global_energy=12#is#global_gem=0#is#global_level=10#is#global_location=P_007TF#is#global_location_timer=False#is#main_quest=P_007TF_Quest33#is#session_id=229#is#session_version=0.2.2#is#eventType=logEvent#is#event=location_enter#is#location=M_001ML#is#type=HOME"
    );

    @Autowired
    StreamingManager streamingManager;
    @Autowired
    BigQueryProperties bigQueryProperties;
    @Autowired
    BigQuery bigquery;
    @Autowired
    BigQueryManager bigQueryManager;


    @SneakyThrows
    @Test
    public void sendByTimeoutTest() {
        String tableTest = "journal_table_test_" + UUID.randomUUID();
        createNewTestTable(tableTest);
        String project = bigQueryProperties.getData().getProject();
        TableName tableName = TableName.newBuilder()
                .setProject(project)
                .setDataset("unit_tests")
                .setTable(tableTest)
                .build();
        streamingManager.createStreamProcessor(tableName);
        for (int i = 0; i < 3; i++) {
            streamingManager.putRowForTable(tableName, createRow());
        }
        Thread.sleep((long) (10 + bigQueryProperties.getStreaming().getAsyncStreamingDelay() * 1000 * 1.5));
        String queryRowCount = String.format("SELECT COUNT(*) FROM `%s.unit_tests.%s` where timestamp is not null", project, tableTest);
        TableResult tableResult = bigQueryManager.query(queryRowCount);
        long count = FieldValueListDecorator.getSingleValue(tableResult).getLongValue();
        Assertions.assertEquals(3, count);
        deleteTable(tableTest);
    }

    @SneakyThrows
    @Test
    public void forceFlushTest() {
        String tableTest = "journal_table_test_" + UUID.randomUUID();
        createNewTestTable(tableTest);
        String project = bigQueryProperties.getData().getProject();
        TableName tableName = TableName.newBuilder()
                .setProject(project)
                .setDataset("unit_tests")
                .setTable(tableTest)
                .build();
        streamingManager.createStreamProcessor(tableName);
        for (int i = 0; i < 3; i++) {
            streamingManager.putRowForTable(tableName, createRow());
        }
        streamingManager.forceFlushStreamForTable(tableName);
        String queryRowCount = String.format("SELECT COUNT(*) FROM `%s.unit_tests.%s` where timestamp is not null", project, tableTest);
        TableResult tableResult = bigQueryManager.query(queryRowCount);
        long count = FieldValueListDecorator.getSingleValue(tableResult).getLongValue();
        Assertions.assertEquals(3, count);
        deleteTable(tableTest);
    }

    private Map<String, Object> createRow() {
        Map<String, Object> record = new HashMap();
        record.put("timestamp", Instant.now().toString());
        record.put("id", UUID.randomUUID().toString());
        record.put("ip", "127.0.0.1");
        record.put("sn", "an");
        record.put("app_id", "pf");
        record.put("data_byte", String.join("!;!", REQ_CONST));
        return record;
    }

    private void createNewTestTable(String tableName) {
        deleteTable(tableName);
        Field[] tableFields = new Field[]{
                Field.of("id", StandardSQLTypeName.STRING),
                Field.of("user_id", StandardSQLTypeName.STRING),
                Field.of("ip", StandardSQLTypeName.STRING),
                Field.of("sn", StandardSQLTypeName.STRING),
                Field.of("app_id", StandardSQLTypeName.STRING),
                Field.of("offset", StandardSQLTypeName.INT64),
                Field.of("timestamp", StandardSQLTypeName.TIMESTAMP),
                Field.of("data_byte", StandardSQLTypeName.STRING)
        };
        createTable(tableName, tableFields);
    }

    public void createTable(String tableName, Field[] fields) {
        Table table = bigquery.getTable(TableId.of("unit_tests", tableName));
        if (table != null) {
            return;
        }
        Schema schema = Schema.of(fields);
        StandardTableDefinition definition = StandardTableDefinition.newBuilder()
                .setSchema(schema)
                .setTimePartitioning(TimePartitioning.of(TimePartitioning.Type.DAY))
                .build();

        bigquery.create(TableInfo.of(TableId.of("unit_tests", tableName), definition));
    }

    public void deleteTable(String tableName) {
        bigquery.delete(TableId.of("unit_tests", tableName));
    }
}
